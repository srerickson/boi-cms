<html>
	<head>
                <script type="text/javascript" src="/javascripts/vendor/jquery-1.5.1.min.js"></script>
		<script type="text/javascript" src="/javascripts/viz.js"></script>
		<script type="text/javascript" src="/javascripts/vendor/d3/d3.js"></script>
		<script type="text/javascript" src="/javascripts/vendor/d3/d3.layout.js"></script>
	</head>

<style>
i
body {
  width:100%;
}

#chart {
  width:1000px;
  height:400;
  margin: 50px auto;
}

#table {
  width:800px;
  margin:20px auto;
}


svg {
  font: 10px sans-serif;
}

circle {
  fill: tan;
  stroke: tan;
}

.active {
  stroke:black;
}

circle.active {
  fill:black;
}

line {
  stroke:tan;
  opacity:0.3;
}

line.active {
  opacity:1;
}

text.label {
  fill:#888;
  cursor:pointer;
}
text.active.label {
  stroke:none;
  fill:#000;
}
text.title {
  font-size:15px;
}



</style>
	
	<body>
		<div id="chart"></div>
                <div id="table"></div>
	
	
	
	
<script type="text/javascript">

var w = 1000,
    h = 350;

var diagonal = d3.svg.diagonal()
    .projection(function(d) { return [d.y, d.x]; });

var vis = d3.select("#chart").append("svg")
    .attr("width", w)
    .attr("height", h)
  .append("g")
    .attr("transform", "translate(250,40)");

d3.json("/org_styles.json", function(json_raw) {
  var nodes = parse_org_style_nodes(json_raw)

  vis.selectAll("circle").data(nodes)
    .enter().append("circle")
    .attr("cx",function(d){ return d.klass == "op" ? 500 : 0})
    .attr("cy",function(d){ return d.index*20})
    .attr("r",function(d){return Math.sqrt(d.size/3.14)+2})
    .attr("id",function(d){return d.klass+"_node_"+urlize(d.name)})
    .attr("class",function(d){ return d.klass+"_"+urlize(d.name)})


  vis.selectAll("text").data(nodes)
    .enter().append("text")
    .attr("x",function(d){ return d.klass == "op" ? 505 : -5})
    .attr("y",function(d){ return d.index*20+3})
    .attr("id", function(d){ return d.klass+"_text_"+urlize(d.name) })
    .attr("class",function(d){ return d.klass+"_"+urlize(d.name)+" label"})
    .attr("text-anchor", function(d){ return d.klass == "fse" ? "end" : "start"})
    .attr("onmouseover",function(d){return "fade_up('"+d.klass+"_"+urlize(d.name)+"')"})
    .attr("onmouseout",function(d){return "fade_out('"+d.klass+"_"+urlize(d.name)+"')"})
    .text(function(d){return d.name})


  // get the links
  d3.json("/birds.json", function(json_raw) {
    var links = parse_org_style_links(json_raw)

    vis.selectAll("line").data(links)
      .enter().append("line")
      .attr("x1",function(d){ return d3.select("#"+d.source).attr("cx")})
      .attr("y1",function(d){ return d3.select("#"+d.source).attr("cy")})
      .attr("x2",function(d){ return d3.select("#"+d.target).attr("cx")})
      .attr("y2",function(d){ return d3.select("#"+d.target).attr("cy")})
      .attr("stroke-width",function(d){return d.weight*1.5})
      .attr("class", function(d){return d.source.replace("node_","") +" "+d.target.replace("node_","")})
  });

  vis.append("text")
    .attr("x",-5)
    .attr("y",-20)
    .attr("class","title")
    .attr("text-anchor", "end")
    .text("FSE Org Styles")


  vis.append("text")
    .attr("x",505)
    .attr("y",-20)
    .attr("class","title")
    .attr("text-anchor","start")
    .text("OP Org Styles")



});

function parse_org_style_nodes(json){
  var ret = []
  for(var i=0;i<json.length;++i){
    var new_fse = {klass:"fse",index:i}
    var new_op = {klass:"op",index:i}

    new_fse.name = json[i].org_style.name
    new_fse.size = json[i].org_style.fse_birds.length

    new_op.name = json[i].org_style.name
    new_op.size = json[i].org_style.op_birds.length

    ret.push(new_fse)
    ret.push(new_op)
  }
  return ret;
}

function parse_org_style_links(json){
  var tmp = {}
  var ret = []
  for(var i=0;i<json.length;++i){
    var bird = json[i].bird
    if(bird.op_org_style_id == null || bird.fse_org_style_id == null){
      continue
    }
    var fse = urlize(bird.fse_org_style.name)
    var op = urlize(bird.op_org_style.name)
    if (tmp[fse+op] == undefined){ 
      var new_link = {
        source: "fse_node_"+urlize(bird.fse_org_style.name),
        target: "op_node_"+urlize(bird.op_org_style.name),
        weight: 1
      }
      tmp[fse+op] = new_link
    } else {
      tmp[fse+op].weight += 1
    }
  }
  for(node in tmp){
    ret.push(tmp[node])
  } 
  console.log(ret)
  return ret;
}


function fade_up(id){
  d3.selectAll("line."+id).each(function(d){
    var classes = d3.select(this).attr("class").split(" ")
    for(var i=0;i<classes.length;++i ){
      d3.select("text."+classes[i]).classed("active",true)
      d3.select("circle."+classes[i]).classed("active",true)

    }
  }).classed("active",true)

}

function fade_out(id){
  d3.selectAll("line."+id).each(function(d){
    var classes = d3.select(this).attr("class").split(" ")
    for(var i=0;i<classes.length;++i ){
      d3.select("text."+classes[i]).classed("active",false)
      d3.select("circle."+classes[i]).classed("active",false)
    }
  }).classed("active",false)
}

function click()




</script>
	
	</body>
</html>
