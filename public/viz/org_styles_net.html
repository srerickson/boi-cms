<html>
	<head>
		<script type="text/javascript" src="/javascripts/viz.js"></script>
		<script type="text/javascript" src="/javascripts/vendor/d3/d3.js"></script>
		<script type="text/javascript" src="/javascripts/vendor/d3/d3.layout.js"></script>
	</head>

<style>
.node circle {
  fill: #fff;
  stroke: steelblue;
  stroke-width: 1.5px;
}

svg {
  font: 10px sans-serif;
}


</style>
	
	<body>
		<div id="chart"></div>
	
	
	
	
<script type="text/javascript">

var w = 1000,
    h = 800;

var diagonal = d3.svg.diagonal()
    .projection(function(d) { return [d.y, d.x]; });

var vis = d3.select("#chart").append("svg")
    .attr("width", w)
    .attr("height", h)
  .append("g")
    .attr("transform", "translate(300,20)");

d3.json("/org_styles.json", function(json_raw) {
  var nodes = parse_org_style_nodes(json_raw)

    vis.selectAll("circle").data(nodes)
      .enter().append("circle")
      .attr("cx",function(d){ return d.klass == "op" ? 500 : 0})
      .attr("cy",function(d){ return d.index*20})
      .attr("r",function(d){return Math.sqrt(d.size/3.14)+2})
      .attr("class",function(d){ return "org_style "+d.klass+"_node"})
      .attr("id",function(d){return d.klass+"_"+urlize(d.name)})

    vis.selectAll("text").data(nodes)
      .enter().append("text")
      .attr("x",function(d){ return d.klass == "op" ? 505 : -5})
      .attr("y",function(d){ return d.index*20})
      .attr("text-anchor", function(d){ return d.klass == "fse" ? "end" : "start"})
      .text(function(d){return d.name})


  // get the links
  d3.json("/birds.json", function(json_raw) {
    var links = parse_org_style_links(json_raw)

    vis.selectAll("line").data(links)
      .enter().append("line")
      .attr("x1",function(d){ return d3.select("#"+d.source).attr("cx")})
      .attr("y1",function(d){ return d3.select("#"+d.source).attr("cy")})
      .attr("x2",function(d){ return d3.select("#"+d.target).attr("cx")})
      .attr("y2",function(d){ return d3.select("#"+d.target).attr("cy")})
      .attr("stroke-width",1)
      .attr("stroke","black")


  });


});


function parse_org_style_nodes(json){
  var ret = []
  for(var i=0;i<json.length;++i){
    var new_fse = {klass:"fse",index:i}
    var new_op = {klass:"op",index:i}
    new_fse.name = json[i].org_style.name
    new_fse.size = json[i].org_style.fse_birds.length

    new_op.name = json[i].org_style.name
    new_op.size = json[i].org_style.op_birds.length
    
    ret.push(new_fse)
    ret.push(new_op)
  }
  return ret;
}


function parse_org_style_links(json){
  var ret = []
  for(var i=0;i<json.length;++i){
    if(json[i].bird.op_org_style_id == null || json[i].bird.fse_org_style_id == null){
      continue
    }
    var new_link = {
      source: "fse_"+urlize(json[i].bird.fse_org_style.name),
      target: "op_"+urlize(json[i].bird.op_org_style.name)
    }
    ret.push(new_link)
  }
  console.log(ret)
  return ret;
}

		
</script>
	
	</body>
</html>
